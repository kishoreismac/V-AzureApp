name: Deploy to Development

on:
  # Run automatically after either workflow finishes, but we will gate on BOTH passing for same SHA
  workflow_run:
    workflows: ["Test and Validate", "Security Scan"]
    branches: [develop]
    types: [completed]

  # Manual trigger for controlled deploys (hotfix / rerun)
  workflow_dispatch:

permissions:
  contents: read
  actions: read
  id-token: write

concurrency:
  group: deploy-dev-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # ==========================================================
  # 1) VERIFY APP PREREQS + READ INFRA CONTRACT FROM APP CONFIG
  # ==========================================================
  verify-prereqs-and-infra:
    name: Verify Prereqs and Infra Contract
    runs-on: ubuntu-latest
    environment: development

    outputs:
      resource_group: ${{ steps.infra.outputs.RESOURCE_GROUP }}
      function_app: ${{ steps.infra.outputs.FUNCTION_APP }}
      app_config: ${{ steps.infra.outputs.APP_CONFIG }}

    steps:
      - name: Determine SHA to deploy
        id: sha
        run: |
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            echo "SHA=${{ github.event.workflow_run.head_sha }}" >> $GITHUB_OUTPUT
            echo "REF=${{ github.event.workflow_run.head_branch }}" >> $GITHUB_OUTPUT
          else
            echo "SHA=${{ github.sha }}" >> $GITHUB_OUTPUT
            echo "REF=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          fi

      - name: 'Gate: Only deploy from develop'
        run: |
          if [ "${{ steps.sha.outputs.REF }}" != "develop" ]; then
            echo "❌ Not on develop branch. Ref is: ${{ steps.sha.outputs.REF }}"
            exit 1
          fi

      - name: Verify required workflows succeeded for this SHA
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SHA: ${{ steps.sha.outputs.SHA }}
        run: |
          echo "Verifying workflow success for SHA: $SHA"

          sudo apt-get update -y && sudo apt-get install -y jq

          # Get recent workflow runs on develop and filter by SHA + workflow name
          RUNS=$(gh api \
            -H "Accept: application/vnd.github+json" \
            "/repos/${{ github.repository }}/actions/runs?branch=develop&per_page=50")

          TEST_OK=$(echo "$RUNS" | jq -r --arg sha "$SHA" '
            [.workflow_runs[]
              | select(.head_sha == $sha)
              | select(.name == "Test and Validate")
              | .conclusion][0] // "missing"
          ')

          SEC_OK=$(echo "$RUNS" | jq -r --arg sha "$SHA" '
            [.workflow_runs[]
              | select(.head_sha == $sha)
              | select(.name == "Security Scan")
              | .conclusion][0] // "missing"
          ')

          echo "Test and Validate conclusion: $TEST_OK"
          echo "Security Scan conclusion:      $SEC_OK"

          if [ "$TEST_OK" != "success" ] || [ "$SEC_OK" != "success" ]; then
            echo ""
            echo "❌ Prerequisites not met for SHA $SHA"
            echo "Expected both workflows to be success."
            exit 1
          fi

          echo "✅ App prereqs satisfied (tests + security)"

      - name: Azure Login (Dev)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID_DEV }}
          audience: api://AzureADTokenExchange

      - name: Read Infra Contract from App Configuration
        id: infra
        run: |
          echo "Reading infra contract from App Config..."

          APP_CONFIG_NAME="${{ vars.APP_CONFIG_NAME_DEV }}"
          if [ -z "$APP_CONFIG_NAME" ]; then
            echo "❌ vars.APP_CONFIG_NAME_DEV is not set in the development environment."
            exit 1
          fi

          SIGNAL=$(az appconfig kv show \
            --name "$APP_CONFIG_NAME" \
            --key "InfraPipeline:Status" \
            --auth-mode login \
            --query "value" -o tsv 2>/dev/null || echo "NOT_FOUND")

          echo "InfraPipeline:Status = $SIGNAL"
          if [ "$SIGNAL" != "COMPLETE" ]; then
            echo "❌ Infrastructure not ready. Expected InfraPipeline:Status=COMPLETE"
            exit 1
          fi

          RESOURCE_GROUP=$(az appconfig kv show \
            --name "$APP_CONFIG_NAME" \
            --key "InfraPipeline:ResourceGroupName" \
            --auth-mode login \
            --query "value" -o tsv)

          FUNCTION_APP=$(az appconfig kv show \
            --name "$APP_CONFIG_NAME" \
            --key "InfraPipeline:FunctionAppName" \
            --auth-mode login \
            --query "value" -o tsv)

          echo "Resolved:"
          echo "  Resource Group: $RESOURCE_GROUP"
          echo "  Function App:   $FUNCTION_APP"

          # Basic sanity
          if [ -z "$RESOURCE_GROUP" ] || [ -z "$FUNCTION_APP" ]; then
            echo "❌ Infra contract values missing in App Config."
            exit 1
          fi

          echo "RESOURCE_GROUP=$RESOURCE_GROUP" >> $GITHUB_OUTPUT
          echo "FUNCTION_APP=$FUNCTION_APP" >> $GITHUB_OUTPUT

  # ===========================
  # 2) BUILD ZIP PACKAGE FOR DEV
  # ===========================
  build-dev-package:
    name: Build Dev Package
    runs-on: ubuntu-latest
    needs: verify-prereqs-and-infra

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Build Azure Functions ZIP package
        run: |
          echo "=== Building Azure Functions Package ==="

          DEPLOY_DIR="deploy-dev"
          rm -rf "$DEPLOY_DIR"
          mkdir -p "$DEPLOY_DIR"

          # Adjust to your actual structure (your tests reference function_app/) :contentReference[oaicite:3]{index=3}
          if [ -d "function_app" ]; then
            cp -r function_app/ "$DEPLOY_DIR/"
          elif [ -d "src" ]; then
            cp -r src/ "$DEPLOY_DIR/"
          else
            find . -maxdepth 1 -name "*.py" -exec cp {} "$DEPLOY_DIR/" \;
          fi

          cp host.json "$DEPLOY_DIR/" 2>/dev/null || echo "No host.json found"
          cp requirements.txt "$DEPLOY_DIR/" 2>/dev/null || echo "No requirements.txt found"

          cat > "$DEPLOY_DIR/.funcignore" << 'EOF'
          __pycache__
          .python_packages
          .venv
          local.settings.json
          .git
          .github
          tests
          *.pem
          *.dev.json
          config.*.json
          EOF

          (cd "$DEPLOY_DIR" && zip -r ../function-app-dev.zip .)
          echo "✅ Created function-app-dev.zip"
          echo "Size: $(du -h function-app-dev.zip | cut -f1)"

      - name: Upload Dev Package
        uses: actions/upload-artifact@v4
        with:
          name: function-app-dev-package
          path: function-app-dev.zip
          retention-days: 7

  # ===========================
  # 3) DEPLOY TO DEV FUNCTION APP
  # ===========================
  deploy-to-dev:
    name: Deploy to Development
    runs-on: ubuntu-latest
    needs: [verify-prereqs-and-infra, build-dev-package]
    environment: development

    steps:
      - name: Download Dev Package
        uses: actions/download-artifact@v4
        with:
          name: function-app-dev-package

      - name: Azure Login (Dev Deployment)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID_DEV }}
          audience: api://AzureADTokenExchange

      - name: Deploy ZIP to Function App
        run: |
          echo "=== DEPLOYING TO DEVELOPMENT ==="

          RESOURCE_GROUP="${{ needs.verify-prereqs-and-infra.outputs.resource_group }}"
          FUNCTION_APP="${{ needs.verify-prereqs-and-infra.outputs.function_app }}"

          echo "Target:"
          echo "  Resource Group: $RESOURCE_GROUP"
          echo "  Function App:   $FUNCTION_APP"
          echo "  Run ID:         ${{ github.run_id }}"

          az functionapp deployment source config-zip \
            --resource-group "$RESOURCE_GROUP" \
            --name "$FUNCTION_APP" \
            --src function-app-dev.zip

          echo "✅ Deployment initiated"

      - name: Verify Deployment
        run: |
          echo "=== VERIFYING DEV DEPLOYMENT ==="

          RESOURCE_GROUP="${{ needs.verify-prereqs-and-infra.outputs.resource_group }}"
          FUNCTION_APP="${{ needs.verify-prereqs-and-infra.outputs.function_app }}"

          sleep 30

          az functionapp show \
            --name "$FUNCTION_APP" \
            --resource-group "$RESOURCE_GROUP" \
            --query "{name:name, state:state, defaultHostName:defaultHostName, lastModifiedTime:lastModifiedTime}" \
            -o table

          HOST=$(az functionapp show \
            --name "$FUNCTION_APP" \
            --resource-group "$RESOURCE_GROUP" \
            --query "defaultHostName" -o tsv)

          echo "URL: https://$HOST"

          if curl -s -f --max-time 10 "https://$HOST" > /dev/null 2>&1; then
            echo "✅ Function App reachable"
          else
            echo "⚠️  Not reachable yet (may still be warming up)"
          fi

      - name: Update App Deployment Status in App Config
        run: |
          echo "=== WRITING APP DEPLOYMENT STATUS ==="

          APP_CONFIG="${{ needs.verify-prereqs-and-infra.outputs.app_config }}"
          RESOURCE_GROUP="${{ needs.verify-prereqs-and-infra.outputs.resource_group }}"

          az appconfig kv set \
            --name "$APP_CONFIG" \
            --key "AppDeployment:Development:Status" \
            --value "DEPLOYED_$(date -u +%Y%m%d_%H%M%S)" \
            --tags "environment=development" \
                   "deployed_at=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" \
                   "run_id=${{ github.run_id }}" \
                   "commit=${{ github.sha }}" \
                   "branch=develop" \
            --auth-mode login \
            --yes

          echo "✅ Updated deployment status"

  # ===========================
  # 4) SUMMARY
  # ===========================
  dev-deployment-summary:
    name: Development Deployment Summary
    runs-on: ubuntu-latest
    needs: [verify-prereqs-and-infra, deploy-to-dev]
    if: always()

    steps:
      - name: Generate Summary
        run: |
          cat > dev-summary.md <<EOF
          # Development Deployment Summary

          ## Deployment
          - Environment: development
          - Resource Group: ${{ needs.verify-prereqs-and-infra.outputs.resource_group }}
          - Function App: ${{ needs.verify-prereqs-and-infra.outputs.function_app }}
          - App Config: ${{ needs.verify-prereqs-and-infra.outputs.app_config }}

          ## Status
          - Verify prereqs + infra: ${{ needs.verify-prereqs-and-infra.result }}
          - Deploy: ${{ needs.deploy-to-dev.result }}

          ## Metadata
          - Run ID: ${{ github.run_id }}
          - Commit: ${{ github.sha }}
          - Branch: develop
          - Completed (UTC): $(date -u '+%Y-%m-%d %H:%M:%S')
          EOF

          cat dev-summary.md

      - name: Upload Summary
        uses: actions/upload-artifact@v4
        with:
          name: dev-deployment-summary
          path: dev-summary.md
          retention-days: 14
