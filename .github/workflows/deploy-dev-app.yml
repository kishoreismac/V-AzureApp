name: Deploy to Development

on:
  # Run after either workflow completes, but we gate on BOTH passing for same SHA
  workflow_run:
    workflows: ["Test and Validate", "Security Scan"]
    branches: [develop]
    types: [completed]

  workflow_dispatch: {}

permissions:
  contents: read
  actions: read
  id-token: write

concurrency:
  # workflow_run doesn't always populate github.ref as expected; use branch-safe grouping
  group: deploy-dev-develop
  cancel-in-progress: false

jobs:
  # ==========================================================
  # 1) VERIFY APP PREREQS + READ INFRA CONTRACT FROM APP CONFIG
  # ==========================================================
  verify-prereqs-and-infra:
    name: Verify Prereqs and Infra Contract
    runs-on: ubuntu-latest
    environment: development

    outputs:
      deploy_sha: ${{ steps.sha.outputs.SHA }}
      deploy_ref: ${{ steps.sha.outputs.REF }}
      resource_group: ${{ steps.infra.outputs.RESOURCE_GROUP }}
      function_app: ${{ steps.infra.outputs.FUNCTION_APP }}
      app_config: ${{ steps.infra.outputs.APP_CONFIG }}

    steps:
      - name: Determine SHA to deploy
        id: sha
        shell: bash
        run: |
          set -euo pipefail
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            echo "SHA=${{ github.event.workflow_run.head_sha }}" >> "$GITHUB_OUTPUT"
            echo "REF=${{ github.event.workflow_run.head_branch }}" >> "$GITHUB_OUTPUT"
          else
            echo "SHA=${{ github.sha }}" >> "$GITHUB_OUTPUT"
            echo "REF=${{ github.ref_name }}" >> "$GITHUB_OUTPUT"
          fi

      - name: Only deploy from develop
        shell: bash
        run: |
          set -euo pipefail
          if [ "${{ steps.sha.outputs.REF }}" != "develop" ]; then
            echo "❌ Not on develop branch. Ref is: ${{ steps.sha.outputs.REF }}"
            exit 1
          fi

      - name: Verify required workflows succeeded for this SHA
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SHA: ${{ steps.sha.outputs.SHA }}
        shell: bash
        run: |
          set -euo pipefail
          echo "Verifying workflow success for SHA: $SHA"

          sudo apt-get update -y >/dev/null
          sudo apt-get install -y jq >/dev/null

          gh --version

          RUNS=$(gh api \
            -H "Accept: application/vnd.github+json" \
            "/repos/${{ github.repository }}/actions/runs?branch=develop&per_page=50")

          TEST_OK=$(echo "$RUNS" | jq -r --arg sha "$SHA" '
            [.workflow_runs[]
              | select(.head_sha == $sha)
              | select(.name == "Test and Validate")
              | .conclusion][0] // "missing"
          ')

          SEC_OK=$(echo "$RUNS" | jq -r --arg sha "$SHA" '
            [.workflow_runs[]
              | select(.head_sha == $sha)
              | select(.name == "Security Scan")
              | .conclusion][0] // "missing"
          ')

          echo "Test and Validate conclusion: $TEST_OK"
          echo "Security Scan conclusion:      $SEC_OK"

          if [ "$TEST_OK" != "success" ] || [ "$SEC_OK" != "success" ]; then
            echo "❌ Prerequisites not met for SHA $SHA"
            exit 1
          fi

          echo "✅ App prereqs satisfied (tests + security)"

      - name: Azure Login (Dev)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID_DEV }}
          audience: api://AzureADTokenExchange

      - name: Read Infra Contract from App Configuration
        id: infra
        shell: bash
        run: |
          set -euo pipefail
          echo "Reading infra contract from App Config..."

          APP_CONFIG_NAME="${{ vars.APP_CONFIG_NAME_DEV }}"
          if [ -z "$APP_CONFIG_NAME" ]; then
            echo "❌ vars.APP_CONFIG_NAME_DEV is not set in the development environment."
            exit 1
          fi

          SIGNAL=$(az appconfig kv show \
            --name "$APP_CONFIG_NAME" \
            --key "InfraPipeline:Status" \
            --auth-mode login \
            --query "value" -o tsv 2>/dev/null || echo "NOT_FOUND")

          echo "InfraPipeline:Status = $SIGNAL"
          if [ "$SIGNAL" != "COMPLETE" ]; then
            echo "❌ Infrastructure not ready. Expected InfraPipeline:Status=COMPLETE"
            exit 1
          fi

          RESOURCE_GROUP=$(az appconfig kv show \
            --name "$APP_CONFIG_NAME" \
            --key "InfraPipeline:ResourceGroupName" \
            --auth-mode login \
            --query "value" -o tsv)

          FUNCTION_APP=$(az appconfig kv show \
            --name "$APP_CONFIG_NAME" \
            --key "InfraPipeline:FunctionAppName" \
            --auth-mode login \
            --query "value" -o tsv)

          echo "Resolved:"
          echo "  Resource Group: $RESOURCE_GROUP"
          echo "  Function App:   $FUNCTION_APP"

          if [ -z "$RESOURCE_GROUP" ] || [ -z "$FUNCTION_APP" ]; then
            echo "❌ Infra contract values missing in App Config."
            exit 1
          fi

          echo "RESOURCE_GROUP=$RESOURCE_GROUP" >> "$GITHUB_OUTPUT"
          echo "FUNCTION_APP=$FUNCTION_APP" >> "$GITHUB_OUTPUT"
          echo "APP_CONFIG=$APP_CONFIG_NAME" >> "$GITHUB_OUTPUT"

  # ===========================
  # 2) BUILD ZIP PACKAGE FOR DEV
  # ===========================
  build-dev-package:
    name: Build Dev Package
    runs-on: ubuntu-latest
    needs: verify-prereqs-and-infra

    steps:
      - name: Checkout code (exact SHA)
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.verify-prereqs-and-infra.outputs.deploy_sha }}
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Build Azure Functions ZIP package (Python v2 layout)
        shell: bash
        run: |
          set -euo pipefail
          echo "=== Building Azure Functions Package (Python v2) ==="

          DEPLOY_DIR="deploy-dev"
          rm -rf "$DEPLOY_DIR"
          mkdir -p "$DEPLOY_DIR"

          # Root files required by Functions runtime
          cp host.json "$DEPLOY_DIR/"
          cp requirements.txt "$DEPLOY_DIR/" 2>/dev/null || echo "No requirements.txt found"

          # IMPORTANT:
          # You currently have v2 model code in function_app/__init__.py.
          # For reliable discovery, place it at ZIP root as function_app.py
          if [ -f "function_app/__init__.py" ]; then
            cp function_app/__init__.py "$DEPLOY_DIR/function_app.py"
          else
            echo "❌ Expected function_app/__init__.py not found."
            exit 1
          fi

          # Optional: include any shared modules under function_app/ (excluding __init__.py)
          # This allows you to later split code into multiple files.
          mkdir -p "$DEPLOY_DIR/function_app"
          rsync -a --exclude="__init__.py" function_app/ "$DEPLOY_DIR/function_app/" || true

          cat > "$DEPLOY_DIR/.funcignore" << 'EOF'
          __pycache__
          .python_packages
          .venv
          local.settings.json
          .git
          .github
          tests
          *.pem
          *.dev.json
          config.*.json
          EOF

          (cd "$DEPLOY_DIR" && zip -r ../function-app-dev.zip .)
          echo "✅ Created function-app-dev.zip"
          echo "Size: $(du -h function-app-dev.zip | cut -f1)"

          echo "=== ZIP ROOT CONTENTS ==="
          unzip -l function-app-dev.zip | head -n 40

      - name: Upload Dev Package
        uses: actions/upload-artifact@v4
        with:
          name: function-app-dev-package
          path: function-app-dev.zip
          retention-days: 7

  # ===========================
  # 3) DEPLOY TO DEV FUNCTION APP
  # ===========================
  deploy-to-dev:
    name: Deploy to Development
    runs-on: ubuntu-latest
    needs: [verify-prereqs-and-infra, build-dev-package]
    environment: development

    steps:
      - name: Download Dev Package
        uses: actions/download-artifact@v4
        with:
          name: function-app-dev-package

      - name: Azure Login (Dev Deployment)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID_DEV }}
          audience: api://AzureADTokenExchange

      # Optional but recommended: ensure app settings are correct for Python runtime
      - name: Ensure Function App runtime settings
        shell: bash
        run: |
          set -euo pipefail
          RESOURCE_GROUP="${{ needs.verify-prereqs-and-infra.outputs.resource_group }}"
          FUNCTION_APP="${{ needs.verify-prereqs-and-infra.outputs.function_app }}"

          echo "Ensuring runtime settings on $FUNCTION_APP ..."

          az functionapp config appsettings set \
            --name "$FUNCTION_APP" \
            --resource-group "$RESOURCE_GROUP" \
            --settings \
              FUNCTIONS_WORKER_RUNTIME=python \
              FUNCTIONS_EXTENSION_VERSION=~4 \
              WEBSITE_RUN_FROM_PACKAGE=1 \
              AzureWebJobsFeatureFlags=EnableWorkerIndexing \
            -o none

          echo "✅ Runtime settings ensured"

      - name: Deploy ZIP to Function App
        shell: bash
        run: |
          set -euo pipefail
          echo "=== DEPLOYING TO DEVELOPMENT ==="

          RESOURCE_GROUP="${{ needs.verify-prereqs-and-infra.outputs.resource_group }}"
          FUNCTION_APP="${{ needs.verify-prereqs-and-infra.outputs.function_app }}"

          echo "Target:"
          echo "  Resource Group: $RESOURCE_GROUP"
          echo "  Function App:   $FUNCTION_APP"
          echo "  Deploy SHA:     ${{ needs.verify-prereqs-and-infra.outputs.deploy_sha }}"
          echo "  Run ID:         ${{ github.run_id }}"

          az functionapp deployment source config-zip \
            --resource-group "$RESOURCE_GROUP" \
            --name "$FUNCTION_APP" \
            --src function-app-dev.zip

          echo "✅ Deployment initiated"

      - name: Verify Functions are indexed (portal visibility check)
        shell: bash
        run: |
          set -euo pipefail
          RESOURCE_GROUP="${{ needs.verify-prereqs-and-infra.outputs.resource_group }}"
          FUNCTION_APP="${{ needs.verify-prereqs-and-infra.outputs.function_app }}"

          echo "Waiting for indexing..."
          sleep 40

          echo "Listing functions..."
          az functionapp function list \
            --name "$FUNCTION_APP" \
            --resource-group "$RESOURCE_GROUP" \
            -o table || true

          COUNT=$(az functionapp function list \
            --name "$FUNCTION_APP" \
            --resource-group "$RESOURCE_GROUP" \
            --query "length(@)" -o tsv 2>/dev/null || echo "0")

          echo "Function count: $COUNT"
          if [ "$COUNT" = "0" ]; then
            echo "❌ No functions detected after deploy. Likely packaging/runtime issue."
            exit 1
          fi

          HOST=$(az functionapp show \
            --name "$FUNCTION_APP" \
            --resource-group "$RESOURCE_GROUP" \
            --query "defaultHostName" -o tsv)

          echo "✅ Host: https://$HOST"
          echo "Note: Your route is /api/http_trigger"
          echo "Example (Function auth required): https://$HOST/api/http_trigger?name=dev"

      - name: Update App Deployment Status in App Config
        shell: bash
        run: |
          set -euo pipefail
          echo "=== WRITING APP DEPLOYMENT STATUS ==="

          APP_CONFIG="${{ needs.verify-prereqs-and-infra.outputs.app_config }}"

          az appconfig kv set \
            --name "$APP_CONFIG" \
            --key "AppDeployment:Development:Status" \
            --value "DEPLOYED_$(date -u +%Y%m%d_%H%M%S)" \
            --tags "environment=development" \
                   "deployed_at=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" \
                   "run_id=${{ github.run_id }}" \
                   "commit=${{ needs.verify-prereqs-and-infra.outputs.deploy_sha }}" \
                   "branch=develop" \
            --auth-mode login \
            --yes

          echo "✅ Updated deployment status"

  # ===========================
  # 4) SUMMARY
  # ===========================
  dev-deployment-summary:
    name: Development Deployment Summary
    runs-on: ubuntu-latest
    needs: [verify-prereqs-and-infra, deploy-to-dev]
    if: always()

    steps:
      - name: Generate Summary
        shell: bash
        run: |
          set -euo pipefail
          cat > dev-summary.md <<EOF
          # Development Deployment Summary

          ## Deployment
          - Environment: development
          - Resource Group: ${{ needs.verify-prereqs-and-infra.outputs.resource_group }}
          - Function App: ${{ needs.verify-prereqs-and-infra.outputs.function_app }}
          - App Config: ${{ needs.verify-prereqs-and-infra.outputs.app_config }}

          ## Deploy Source
          - Deploy SHA: ${{ needs.verify-prereqs-and-infra.outputs.deploy_sha }}
          - Branch: develop

          ## Status
          - Verify prereqs + infra: ${{ needs.verify-prereqs-and-infra.result }}
          - Deploy: ${{ needs.deploy-to-dev.result }}

          ## Metadata
          - Run ID: ${{ github.run_id }}
          - Completed (UTC): $(date -u +'%Y-%m-%d %H:%M:%S')
          EOF

          cat dev-summary.md

      - name: Upload Summary
        uses: actions/upload-artifact@v4
        with:
          name: dev-deployment-summary
          path: dev-summary.md
          retention-days: 14
