name: Test and Validate

on:
  pull_request:
    branches: [develop]
  push:
    branches: [develop]
  workflow_dispatch:

jobs:
  validate-code:
    name: Code Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
      
      - name: Install pre-commit and tools
        run: |
          pip install pre-commit black pylint flake8 mypy
      
      # ========================================
      # 1. PRE-COMMIT CHECKS
      # ========================================
      - name: Run pre-commit hooks
        id: precommit
        run: |
          echo "=== Running pre-commit hooks ==="
          
          # Initialize pre-commit in the repository
          pre-commit install
          
          # Run all hooks
          pre-commit run --all-files || true
          
          # Specifically check black formatting
          echo ""
          echo "=== Checking Black formatting ==="
          pre-commit run black --all-files || echo "Black would reformat files"
          
          # Check if black would change anything
          if pre-commit run black --all-files 2>&1 | grep -q "files would be reformatted"; then
            echo "âŒ Formatting issues found"
            echo "FORMAT_OK=false" >> $GITHUB_OUTPUT
          else
            echo "âœ… Code formatting is correct"
            echo "FORMAT_OK=true" >> $GITHUB_OUTPUT
          fi
      
      # ========================================
      # 2. ADDITIONAL CHECKS (Optional)
      # ========================================
      - name: Run Pylint
        if: steps.precommit.outputs.FORMAT_OK == 'true'
        run: |
          echo "=== Running Pylint ==="
          pylint function_app/ --fail-under=7.0 || echo "Pylint score below threshold"
        continue-on-error: true
      
      - name: Run Flake8
        if: steps.precommit.outputs.FORMAT_OK == 'true'
        run: |
          echo "=== Running Flake8 ==="
          flake8 function_app/ --max-complexity=10
        continue-on-error: true
      
      - name: Run MyPy type checking
        if: steps.precommit.outputs.FORMAT_OK == 'true'
        run: |
          echo "=== Running MyPy ==="
          mypy function_app/ --ignore-missing-imports || echo "Type checking issues found"
        continue-on-error: true
      
      # ========================================
      # 3. AZURE FUNCTIONS VALIDATION
      # ========================================
      - name: Validate Azure Functions structure
        run: |
          echo "=== Validating Azure Functions Structure ==="
          
          # Check for required files
          REQUIRED_FILES=("host.json")
          for file in "${REQUIRED_FILES[@]}"; do
            if [ ! -f "$file" ]; then
              echo "âŒ Missing required file: $file"
              exit 1
            fi
          done
          
          # Check function.json files
          find . -name "function.json" -type f 2>/dev/null | while read func_file; do
            echo "Validating: $func_file"
            if ! python -m json.tool "$func_file" > /dev/null 2>&1; then
              echo "âŒ Invalid JSON in $func_file"
              exit 1
            fi
          done
          
          echo "âœ… Azure Functions structure valid"
  
  run-tests:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: validate-code
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
      
      - name: Install test dependencies
        run: |
          pip install pytest pytest-cov azure-functions
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
      
      - name: Run unit tests
        run: |
          echo "=== Running Unit Tests ==="
          
          if [ -d "tests" ] && [ -n "$(find tests -name '*.py' -type f)" ]; then
            # Run tests with coverage
            python -m pytest tests/unit -v --cov=function_app --cov-report=xml --cov-report=html
          else
            echo "âš ï¸ No unit tests found in tests/unit"
            mkdir -p tests/unit
            echo "# Add unit tests here" > tests/unit/test_example.py
          fi
        continue-on-error: true
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ github.run_id }}
          path: |
            coverage.xml
            htmlcov/
          retention-days: 7
  
  # ========================================
  # 4. FINAL VALIDATION SUMMARY
  # ========================================
  validation-summary:
    name: Validation Summary
    runs-on: ubuntu-latest
    needs: [validate-code, run-tests]
    if: always()
    
    steps:
      - name: Generate Validation Report
        run: |
          echo "# Validation Summary" > validation-report.md
          echo "" >> validation-report.md
          echo "## ðŸ“Š Results" >> validation-report.md
          echo "" >> validation-report.md
          echo "- **Code Validation:** ${{ needs.validate-code.result }}" >> validation-report.md
          echo "- **Tests:** ${{ needs.run-tests.result }}" >> validation-report.md
          echo "" >> validation-report.md
          
          # Add formatting status if available
          if [ -n "${{ needs.validate-code.outputs.FORMAT_OK }}" ]; then
            if [ "${{ needs.validate-code.outputs.FORMAT_OK }}" = "true" ]; then
              echo "- **Code Formatting:** âœ… Passed" >> validation-report.md
            else
              echo "- **Code Formatting:** âŒ Needs formatting" >> validation-report.md
            fi
          fi
          
          echo "" >> validation-report.md
          echo "## ðŸš€ Next Steps" >> validation-report.md
          echo "" >> validation-report.md
          
          if [ "${{ job.status }}" = "success" ]; then
            echo "âœ… All checks passed! Ready for deployment." >> validation-report.md
            echo "" >> validation-report.md
            echo "You can now run the deployment workflow." >> validation-report.md
          else
            echo "âŒ Some checks failed. Please fix the issues above." >> validation-report.md
            echo "" >> validation-report.md
            echo "Common fixes:" >> validation-report.md
            echo "1. Run `pre-commit run --all-files` locally" >> validation-report.md
            echo "2. Fix any test failures" >> validation-report.md
            echo "3. Ensure Azure Functions structure is correct" >> validation-report.md
          fi
          
          echo "" >> validation-report.md
          echo "---" >> validation-report.md
          echo "*Run ID: ${{ github.run_id }}*" >> validation-report.md
          
          cat validation-report.md
      
      - name: Upload Validation Report
        uses: actions/upload-artifact@v4
        with:
          name: validation-report
          path: validation-report.md