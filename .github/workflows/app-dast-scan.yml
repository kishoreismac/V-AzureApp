name: App DAST Scan (Development)

on:
  # Run ONLY after integration workflow succeeds (post-deploy)
  workflow_run:
    workflows:
      - "App Integration Tests (Development)"   # <-- MUST match your integration workflow name exactly
    types: [completed]

  workflow_dispatch: {}

permissions:
  contents: read
  actions: read
  id-token: write

concurrency:
  group: dast-dev-develop
  cancel-in-progress: false

jobs:
  # ==========================================================
  # 1) RESOLVE TARGET URL (NO BUILD/DEPLOY/TEST REPEATS)
  # ==========================================================
  resolve-target:
    name: Resolve DAST Target (Dev)
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    environment: development

    outputs:
      target_url: ${{ steps.out.outputs.TARGET_URL }}
      host: ${{ steps.out.outputs.HOST }}

    steps:
      - name: Azure Login (Dev)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID_DEV }}
          audience: api://AzureADTokenExchange

      - name: Resolve host (App Config preferred; ARM fallback)
        id: out
        shell: bash
        run: |
          set -euo pipefail

          APP_CONFIG_NAME="${{ vars.APP_CONFIG_NAME_DEV }}"
          if [ -z "$APP_CONFIG_NAME" ]; then
            echo "❌ vars.APP_CONFIG_NAME_DEV is not set for environment 'development'."
            exit 1
          fi

          # Prefer: value written by deploy workflow (you can add this key in deploy once stable)
          # AppDeployment:Development:Host = <app>.azurewebsites.net
          HOST=$(az appconfig kv show \
            --name "$APP_CONFIG_NAME" \
            --key "AppDeployment:Development:Host" \
            --auth-mode login \
            --query "value" -o tsv 2>/dev/null || true)

          # If not found, fall back to infra contract + ARM lookup
          if [ -z "$HOST" ] || [ "$HOST" = "null" ]; then
            RESOURCE_GROUP=$(az appconfig kv show \
              --name "$APP_CONFIG_NAME" \
              --key "InfraPipeline:ResourceGroupName" \
              --auth-mode login \
              --query "value" -o tsv)

            FUNCTION_APP=$(az appconfig kv show \
              --name "$APP_CONFIG_NAME" \
              --key "InfraPipeline:FunctionAppName" \
              --auth-mode login \
              --query "value" -o tsv)

            if [ -z "$RESOURCE_GROUP" ] || [ -z "$FUNCTION_APP" ]; then
              echo "❌ Missing InfraPipeline:ResourceGroupName or InfraPipeline:FunctionAppName in App Config."
              exit 1
            fi

            RID=$(az functionapp show \
              --name "$FUNCTION_APP" \
              --resource-group "$RESOURCE_GROUP" \
              --query "id" -o tsv)

            HOST=$(az resource show --ids "$RID" --query "properties.defaultHostName" -o tsv 2>/dev/null || true)
            if [ -z "$HOST" ] || [ "$HOST" = "null" ]; then
              HOST=$(az resource show --ids "$RID" --query "properties.hostNames[0]" -o tsv 2>/dev/null || true)
            fi
          fi

          if [ -z "$HOST" ] || [ "$HOST" = "null" ]; then
            echo "❌ Could not resolve host for DAST."
            exit 1
          fi

          # Your function route (adjust if you change it)
          # NOTE: If your function requires AuthLevel.FUNCTION, provide code via secret.
          BASE="https://$HOST/api/http_trigger"
          if [ -n "${{ secrets.AZURE_FUNCTION_KEY_DEV }}" ]; then
            TARGET_URL="${BASE}?name=dast&code=${{ secrets.AZURE_FUNCTION_KEY_DEV }}"
          else
            # DAST will still run, but may get 401/403 if auth is enforced.
            TARGET_URL="${BASE}?name=dast"
          fi

          echo "Resolved:"
          echo "  HOST=$HOST"
          echo "  TARGET_URL=$TARGET_URL"

          echo "HOST=$HOST" >> "$GITHUB_OUTPUT"
          echo "TARGET_URL=$TARGET_URL" >> "$GITHUB_OUTPUT"

  # ==========================================================
  # 2) DAST (OWASP ZAP BASELINE)
  # ==========================================================

      - name: DAST (OWASP ZAP Baseline)
        shell: bash
        run: |
          set -euo pipefail

          HOST="v-sample-python-dev.azurewebsites.net"   # or resolve dynamically like your deploy workflow
          RESOURCE_GROUP="rg-vsamplepython-dev"
          FUNCTION_APP="v-sample-python-dev"

          echo "Resolving function key..."
          KEY=$(az functionapp keys list \
            --name "$FUNCTION_APP" \
            --resource-group "$RESOURCE_GROUP" \
            --query "functionKeys.default" -o tsv 2>/dev/null || true)

          if [ -z "$KEY" ] || [ "$KEY" = "null" ]; then
            KEY=$(az functionapp keys list \
              --name "$FUNCTION_APP" \
              --resource-group "$RESOURCE_GROUP" \
              --query "functionKeys | values(@)[0]" -o tsv 2>/dev/null || true)
          fi

          if [ -z "$KEY" ] || [ "$KEY" = "null" ]; then
            echo "❌ Could not retrieve function key (RBAC missing)."
            exit 1
          fi

          DAST_TARGET="https://${HOST}/api/http_trigger?name=dast&code=${KEY}"
          echo "DAST target: ${DAST_TARGET}"

          mkdir -p zap-out
          chmod 777 zap-out

          # Create a minimal automation plan that writes reports to a writable location
          cat > zap.yaml <<EOF
          env:
            contexts:
              - name: default
                urls:
                  - "https://${HOST}/"
          jobs:
            - type: spider
              parameters:
                url: "${DAST_TARGET}"
                maxDuration: 2
            - type: passiveScan-wait
              parameters:
                maxDuration: 240
            - type: outputSummary
              parameters:
                format: LONG
                summaryFile: "/home/zap/wrk/zap_out.json"
            - type: report
              parameters:
                reportDir: "/home/zap/wrk"
                reportFile: "zap-report.json"
                template: "traditional-json"
                reportTitle: "ZAP Scanning Report"
          EOF

          docker run --rm \
            -v "$PWD/zap.yaml:/home/zap/zap.yaml:ro" \
            -v "$PWD/zap-out:/home/zap/wrk" \
            ghcr.io/zaproxy/zaproxy:stable \
            zap.sh -cmd -autorun /home/zap/zap.yaml

          echo "=== ZAP OUT DIR ==="
          ls -la zap-out

          echo "=== Parse report and enforce policy (fail only on High) ==="
          python3 - << 'PY'
          import json, sys, pathlib
          p = pathlib.Path("zap-out/zap-report.json")
          if not p.exists():
            print("❌ Missing zap-report.json. Found:")
            for f in sorted(pathlib.Path("zap-out").glob("*")):
              print(" -", f.name)
            sys.exit(2)

          data = json.loads(p.read_text(encoding="utf-8"))
          highs = 0
          mediums = 0

          for site in data.get("site", []):
            for a in site.get("alerts", []):
              rc = str(a.get("riskcode", "0"))
              if rc == "3": highs += 1
              elif rc == "2": mediums += 1

          print(f"ZAP summary: High={highs}, Medium={mediums}")
          if highs > 0:
            print("❌ DAST policy failed: High findings detected.")
            sys.exit(3)

          print("✅ DAST policy passed (no High findings).")
          PY


  # ==========================================================
  # 3) WRITE STATUS (NO REPEATS)
  # ==========================================================
  write-status:
    name: Write DAST Status (App Config)
    runs-on: ubuntu-latest
    needs: [resolve-target, dast]
    if: always()
    environment: development

    steps:
      - name: Azure Login (Dev)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID_DEV }}
          audience: api://AzureADTokenExchange

      - name: Write status to App Config
        shell: bash
        run: |
          set -euo pipefail

          APP_CONFIG_NAME="${{ vars.APP_CONFIG_NAME_DEV }}"
          if [ -z "$APP_CONFIG_NAME" ]; then
            echo "❌ vars.APP_CONFIG_NAME_DEV is not set."
            exit 1
          fi

          RESULT="${{ needs.dast.result }}"
          TS="$(date -u +%Y%m%d_%H%M%S)"
          VALUE="${RESULT}_${TS}"

          az appconfig kv set \
            --name "$APP_CONFIG_NAME" \
            --key "DAST:Development:Status" \
            --value "$VALUE" \
            --tags \
              "environment=development" \
              "run_id=${{ github.run_id }}" \
              "tested_at=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" \
              "host=${{ needs.resolve-target.outputs.host }}" \
            --auth-mode login \
            --yes \
            -o jsonc

          echo "✅ Wrote DAST:Development:Status = $VALUE"
